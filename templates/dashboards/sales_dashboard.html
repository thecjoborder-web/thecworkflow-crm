{% extends "base.html" %}
{% block content %}

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        color: #333;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #E53935 0%, #1a1a1a 100%);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .dashboard-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .dashboard-subtitle {
        font-size: 14px;
        opacity: 0.95;
    }

    /* ==================== KPI SECTION ==================== */
    .kpi-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .kpi-box {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-box:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .kpi-box h3 {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: #999;
        margin-bottom: 10px;
        letter-spacing: 0.5px;
    }

    .kpi-box p {
        font-size: 32px;
        font-weight: 700;
        color: #E53935;
    }

    /* ==================== PIPELINE STAGES ==================== */
    .pipeline-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .pipeline-stage {
        margin-bottom: 50px;
    }

    .pipeline-stage:last-child {
        margin-bottom: 0;
    }

    .stage-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .stage-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 12px;
        display: inline-block;
    }

    .stage-icon.assigned { background-color: #E53935; }
    .stage-icon.contacted { background-color: #D32F2F; }
    .stage-icon.awaiting { background-color: #1a1a1a; }
    .stage-icon.closed { background-color: #E53935; }
    .stage-icon.lost { background-color: #1a1a1a; }

    .stage-title {
        font-size: 20px;
        font-weight: 700;
        color: #333;
        flex-grow: 1;
    }

    .stage-count {
        background-color: #f5f5f5;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: #666;
    }

    .leads-grid {
        display: grid;
        gap: 16px;
    }

    .empty-stage {
        padding: 40px;
        text-align: center;
        color: #999;
        background: #f9f9f9;
        border-radius: 8px;
        border: 2px dashed #ddd;
    }

    /* ==================== LEAD CARD ==================== */
    .lead-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        transition: all 0.2s;
    }

    .lead-card:hover {
        border-color: #E53935;
        box-shadow: 0 4px 12px rgba(229, 57, 53, 0.15);
    }

    .lead-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .lead-info {
        flex-grow: 1;
    }

    .lead-name {
        font-size: 16px;
        font-weight: 700;
        color: #333;
        margin-bottom: 4px;
    }

    .lead-meta {
        font-size: 13px;
        color: #999;
        line-height: 1.4;
    }

    .lead-status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: white;
    }

    .lead-status.assigned { background-color: #E53935; }
    .lead-status.contacted { background-color: #D32F2F; }
    .lead-status.awaiting { background-color: #1a1a1a; color: white; }
    .lead-status.closed { background-color: #E53935; }
    .lead-status.lost { background-color: #1a1a1a; }

    /* ==================== CONTACT BUTTONS ==================== */
    .contact-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: opacity 0.2s, transform 0.2s;
    }

    .btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .btn-whatsapp { background-color: #25D366; color: white; }
    .btn-call { background-color: #E53935; color: white; }
    .btn-email { background-color: #EA4335; color: white; }
    .btn-note { background-color: #9C27B0; color: white; }

    /* ==================== STAGE BUTTONS ==================== */
    .stage-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f0f0f0;
    }

    .stage-btn {
        padding: 8px 12px;
        border: 1px solid #E53935;
        background: white;
        color: #E53935;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .stage-btn:hover {
        background-color: #E53935;
        color: white;
        transform: translateY(-2px);
    }

    .stage-btn.danger {
        border-color: #F44336;
        color: #F44336;
    }

    .stage-btn.danger:hover {
        background-color: #F44336;
        color: white;
    }

    /* ==================== ACTIVITIES SECTION ==================== */
    .activities-section {
        background-color: #f9f9f9;
        border: 1px solid #f0f0f0;
        border-radius: 4px;
        padding: 12px;
        margin-top: 12px;
    }

    .activities-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: #666;
        font-size: 13px;
    }

    .activity {
        background: white;
        padding: 8px;
        margin-bottom: 8px;
        border-left: 3px solid #E53935;
        border-radius: 2px;
        font-size: 12px;
    }

    .activity.note { border-left-color: #1a1a1a; }
    .activity.call { border-left-color: #E53935; }
    .activity.whatsapp { border-left-color: #25D366; }
    .activity.email { border-left-color: #E53935; }
    .activity.status { border-left-color: #1a1a1a; }

    .activity-type {
        font-weight: 600;
        color: #E53935;
        font-size: 10px;
        text-transform: uppercase;
        display: inline-block;
        margin-bottom: 4px;
    }

    .activity-message {
        color: #333;
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .activity-meta {
        font-size: 10px;
        color: #999;
    }

    .no-activities {
        color: #999;
        font-size: 12px;
        font-style: italic;
        padding: 8px 0;
    }

    /* ==================== ACTIVITY FILTER ==================== */
    .activity-filter-container {
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .activity-filter-label {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: #999;
        margin-bottom: 10px;
        display: block;
    }

    #activityFilter {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        background-color: white;
        transition: border-color 0.2s;
    }

    #activityFilter:focus {
        outline: none;
        border-color: #667eea;
    }

    /* ==================== MODAL ==================== */
    #note-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 400px;
        max-width: 500px;
        display: none;
    }

    #note-modal.active {
        display: block;
    }

    #note-modal h3 {
        font-size: 20px;
        margin-bottom: 20px;
        color: #333;
    }

    #note-content {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        resize: vertical;
        margin-bottom: 20px;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 999;
        display: none;
    }

    .modal-overlay.active {
        display: block;
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 1024px) {
        .kpi-container {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .dashboard-header {
            padding: 20px;
        }

        .dashboard-title {
            font-size: 22px;
        }

        .kpi-container {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .pipeline-container {
            padding: 20px;
        }

        #note-modal {
            min-width: 90%;
            max-width: 90%;
        }
    }

    /* ==================== CSRF TOKEN FORM ==================== */
    .csrf-form {
        display: none;
    }
</style>

<!-- ‚úÖ CSRF TOKEN FORM (REQUIRED FOR AJAX) -->
<form class="csrf-form">
    {% csrf_token %}
</form>

<!-- ==================== DASHBOARD HEADER ==================== -->
<div class="dashboard-header">
    <div class="dashboard-title">üìä Sales Dashboard</div>
    <div class="dashboard-subtitle">Real-time pipeline tracking and KPI metrics</div>
</div>

<!-- ==================== STEP 2: KPI CARDS ==================== -->
<div class="kpi-container">
    <div class="kpi-box">
        <h3>üìà Total Leads</h3>
        <p>{{ total_leads }}</p>
    </div>

    <div class="kpi-box">
        <h3>üî• Active Leads</h3>
        <p>{{ active_leads }}</p>
    </div>

    <div class="kpi-box">
        <h3>‚è≥ Awaiting Client</h3>
        <p>{{ awaiting_count }}</p>
    </div>

    <div class="kpi-box">
        <h3>‚úÖ Closed Deals</h3>
        <p>{{ closed_count }}</p>
    </div>

    <div class="kpi-box">
        <h3>üìä Conversion %</h3>
        <p>{{ conversion_rate }}%</p>
    </div>

    <div class="kpi-box">
        <h3>üìû Activities Today</h3>
        <p>{{ activities_today }}</p>
    </div>
</div>

<!-- ==================== STEP 5: ACTIVITY FILTER ==================== -->
<div class="activity-filter-container">
    <label class="activity-filter-label">Filter Activities</label>
    <select id="activityFilter">
        <option value="">All Activity Types</option>
        <option value="call">‚òéÔ∏è Calls</option>
        <option value="whatsapp">üí¨ WhatsApp</option>
        <option value="email">‚úâÔ∏è Email</option>
        <option value="note">üìù Notes</option>
        <option value="status">üîÑ Status Changes</option>
    </select>
</div>

<!-- ==================== STEP 3: PIPELINE SECTIONS ==================== -->
<div class="pipeline-container">

    <!-- üü¶ ASSIGNED LEADS -->
    <div class="pipeline-stage">
        <div class="stage-header">
            <span class="stage-icon assigned"></span>
            <div class="stage-title">üü¶ Assigned Leads</div>
            <span class="stage-count">{{ assigned_leads|length }}</span>
        </div>
        {% if assigned_leads %}
            <div class="leads-grid">
                {% for lead in assigned_leads %}
                    {% include "dashboards/partials/lead_card.html" %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-stage">No assigned leads yet</div>
        {% endif %}
    </div>

    <!-- üüß CONTACTED -->
    <div class="pipeline-stage">
        <div class="stage-header">
            <span class="stage-icon contacted"></span>
            <div class="stage-title">üüß Contacted</div>
            <span class="stage-count">{{ contacted_leads|length }}</span>
        </div>
        {% if contacted_leads %}
            <div class="leads-grid">
                {% for lead in contacted_leads %}
                    {% include "dashboards/partials/lead_card.html" %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-stage">No contacted leads yet</div>
        {% endif %}
    </div>

    <!-- üü® AWAITING CLIENT -->
    <div class="pipeline-stage">
        <div class="stage-header">
            <span class="stage-icon awaiting"></span>
            <div class="stage-title">üü® Awaiting Client</div>
            <span class="stage-count">{{ awaiting_leads|length }}</span>
        </div>
        {% if awaiting_leads %}
            <div class="leads-grid">
                {% for lead in awaiting_leads %}
                    {% include "dashboards/partials/lead_card.html" %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-stage">No awaiting leads</div>
        {% endif %}
    </div>

    <!-- üü© CLOSED DEALS -->
    <div class="pipeline-stage">
        <div class="stage-header">
            <span class="stage-icon closed"></span>
            <div class="stage-title">üü© Closed Deals</div>
            <span class="stage-count">{{ closed_leads|length }}</span>
        </div>
        {% if closed_leads %}
            <div class="leads-grid">
                {% for lead in closed_leads %}
                    {% include "dashboards/partials/lead_card.html" %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-stage">No closed deals yet</div>
        {% endif %}
    </div>

    <!-- üü• LOST DEALS -->
    <div class="pipeline-stage">
        <div class="stage-header">
            <span class="stage-icon lost"></span>
            <div class="stage-title">üü• Lost Deals</div>
            <span class="stage-count">{{ lost_leads|length }}</span>
        </div>
        {% if lost_leads %}
            <div class="leads-grid">
                {% for lead in lost_leads %}
                    {% include "dashboards/partials/lead_card.html" %}
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-stage">No lost deals</div>
        {% endif %}
    </div>

</div>

<!-- ==================== NOTE MODAL ==================== -->
<div id="note-modal">
    <h3>üìù Add Note</h3>
    <textarea id="note-content" rows="4" placeholder="Enter your note here..."></textarea>
    <div class="modal-buttons">
        <button id="save-note-btn" class="btn btn-note">Save Note</button>
        <button id="cancel-note-btn" class="btn" style="background-color: #999; color: white;">Cancel</button>
    </div>
</div>

<div id="note-modal-overlay" class="modal-overlay"></div>

{% endblock %}

{% block extra_scripts %}
<script>
// ==================== CSRF TOKEN ==================== 
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// ==================== WhatsApp helper ====================
function openWhatsApp(phone, name){
    try {
        var text = encodeURIComponent('Hello ' + (name || ''));
        var isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
        // Always use wa.me which reliably redirects to the correct client
        var url = 'https://wa.me/' + phone + '?text=' + text;

        // If we have a previously opened reference (from this page), try to reuse it
        try {
            if (!window.__whatsappWindow || window.__whatsappWindow.closed) {
                window.__whatsappWindow = window.open(url, 'thec_whatsapp_window');
            } else {
                // If reference exists, update its location to the new chat and focus it
                try {
                    window.__whatsappWindow.location.href = url;
                } catch (innerErr) {
                    // cross-origin assignment may fail in some browsers; fall back to reopening
                    window.__whatsappWindow = window.open(url, 'thec_whatsapp_window');
                }
                window.__whatsappWindow.focus();
            }
            // On mobile open a new tab/window instead of reusing
            if(isMobile){
                // Mobile browsers typically open app or chooser; ensure a new tab
                window.open(url, '_blank');
            }
        } catch (winErr) {
            console.error('whatsapp window reuse failed', winErr);
            window.open(url, '_blank');
        }
    } catch (e) {
        console.error('openWhatsApp error', e);
        window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(name || ''), '_blank');
    }
}

// Helper: Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ==================== LOAD ACTIVITIES ==================== 
function loadActivities(leadId) {
    const activitiesDiv = document.querySelector(
        `.activities-list[data-lead-id="${leadId}"]`
    );

    if (!activitiesDiv) {
        console.warn('Activities div not found for lead:', leadId);
        return;
    }

    const filterType = document.getElementById('activityFilter').value;
    const url = `/dashboard/lead/${leadId}/activities/${filterType ? '?type=' + filterType : ''}`;

    console.log('üì• Fetching activities from:', url);

    fetch(url)
        .then(response => {
            console.log('üìä Response status:', response.status, response.statusText);
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Activities data received:', data);
            if (data.error) {
                activitiesDiv.innerHTML = `<div class="no-activities">‚ùå Error: ${escapeHtml(data.error)}</div>`;
            } else if (!data.activities || data.activities.length === 0) {
                activitiesDiv.innerHTML = '<div class="no-activities">üì≠ No activities yet</div>';
            } else {
                activitiesDiv.innerHTML = data.activities.map(activity => `
                    <div class="activity ${activity.activity_type}">
                        <span class="activity-type">${activity.activity_type}</span>
                        <div class="activity-message">${escapeHtml(activity.message)}</div>
                        <div class="activity-meta">By ${escapeHtml(activity.created_by)} ‚Ä¢ ${activity.created_at}</div>
                    </div>
                `).join('');
            }
        })
        .catch(error => {
            console.error('üö® Error loading activities:', error);
            activitiesDiv.innerHTML = `<div class="no-activities">‚ö†Ô∏è Error: ${escapeHtml(error.message)}</div>`;
        });
}

// Load activities for all leads on page load
function loadAllActivities() {
    document.querySelectorAll('.lead-card').forEach(card => {
        const leadId = card.dataset.leadId;
        loadActivities(leadId);
    });
}

loadAllActivities();

// ==================== ACTIVITY FILTER CHANGE ==================== 
document.getElementById('activityFilter').addEventListener('change', () => {
    loadAllActivities();
});

// ==================== STAGE PROGRESSION BUTTONS ==================== 
document.querySelectorAll('.stage-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
        const card = e.target.closest('.lead-card');
        const leadId = card.dataset.leadId;
        const newStage = e.target.dataset.stage;

        const response = await fetch("{% url 'dashboards:log_activity' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                lead_id: leadId,
                activity_type: 'status',
                message: `Lead moved to ${newStage}`,
                new_stage: newStage
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Update status badge
            const statusBadge = card.querySelector('.lead-status');
            statusBadge.textContent = newStage.charAt(0).toUpperCase() + newStage.slice(1);
            statusBadge.className = `lead-status ${newStage}`;

            // Remove old stage buttons and update
            const stageButtons = card.querySelector('.stage-buttons');
            stageButtons.innerHTML = generateStageButtons(newStage);

            // Reload activities
            loadActivities(leadId);

            // Optional: Show notification
            alert(`Lead moved to ${newStage}!`);
            
            // Reload page after 1 second to refresh UI
            setTimeout(() => location.reload(), 1000);
        } else {
            alert(`Error: ${data.error}`);
        }
    });
});

// Generate stage buttons based on current status
function generateStageButtons(currentStatus) {
    const buttons = {
        'assigned': '<button class="stage-btn" data-stage="contacted">‚Üí Mark Contacted</button>',
        'contacted': '<button class="stage-btn" data-stage="awaiting">‚Üí Move to Awaiting</button>',
        'awaiting': '<button class="stage-btn" data-stage="closed">‚úì Mark Closed</button><button class="stage-btn danger" data-stage="lost">‚úó Mark Lost</button>',
        'closed': '',
        'lost': ''
    };
    return buttons[currentStatus] || '';
}

// ==================== ADD NOTE MODAL ==================== 
let currentLeadId = null;
const noteModal = document.getElementById('note-modal');
const modalOverlay = document.getElementById('note-modal-overlay');

// Open modal when "Add Note" is clicked
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-note-btn')) {
        const card = e.target.closest('.lead-card');
        if (card) {
            currentLeadId = card.dataset.leadId;
            console.log('üìù Opening note modal for lead:', currentLeadId);
            document.getElementById('note-content').value = '';
            noteModal.classList.add('active');
            modalOverlay.classList.add('active');
        }
    }
});

function closeModal() {
    console.log('‚ùå Closing modal');
    noteModal.classList.remove('active');
    modalOverlay.classList.remove('active');
    document.getElementById('note-content').value = '';
}

// Close on Cancel button
document.getElementById('cancel-note-btn').addEventListener('click', function(e) {
    e.preventDefault();
    closeModal();
});

// Close on overlay click
modalOverlay.addEventListener('click', function(e) {
    e.preventDefault();
    closeModal();
});

// Save note on Save button
document.getElementById('save-note-btn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    const content = document.getElementById('note-content').value.trim();

    if (!content) {
        alert("üìù Note cannot be empty");
        return;
    }

    console.log('üíæ Saving note for lead:', currentLeadId);
    console.log('üìÑ Note content:', content);

    try {
        const response = await fetch("{% url 'dashboards:log_activity' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                lead_id: currentLeadId,
                activity_type: 'note',
                message: content
            })
        });

        console.log('üìä Save response status:', response.status);

        if (!response.ok) {
            const errorData = await response.json();
            console.error('‚ùå Error saving note:', errorData);
            alert(`‚ùå Error: ${errorData.error || 'Unknown error'}`);
            return;
        }

        const data = await response.json();
        console.log('‚úÖ Note saved successfully:', data);
        
        closeModal();
        
        // Reload activities after short delay
        setTimeout(() => {
            loadActivities(currentLeadId);
            console.log('üîÑ Activities reloaded');
        }, 300);
        
        alert("‚úÖ Note saved successfully!");
        
    } catch (error) {
        console.error('üö® Exception saving note:', error);
        alert(`‚ùå Error: ${error.message}`);
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && noteModal.classList.contains('active')) {
        closeModal();
    }
});
</script>
{% endblock %}

